{{define "second-navbar"}}
<!-- Graphs Nav -->
<nav class="navbar navbar-default">
    <div class="container graphs">
        <div class="row">
            <div class="col-lg-10" style="padding-right: 0">
                <select class="form-control graphs-select">
                {{ range $graph := .Graphs }}
                    <option value="{{ $graph.ID }}" {{if eq $graph.ID $.CurrentGraph.ID }}selected="selected"{{ end }}>{{ $graph.Name }}</option>
                {{ end }}
                </select>
            </div>

            <div class="col-lg-2" style="padding-left: 0">
                <button class="btn btn-primary btn-block" data-toggle="modal" data-target="#add-chart-modal" data-graph-id="{{ $.CurrentGraph.ID }}">
                    Add Charts
                </button>
            </div>
        </div>
    </div>
</nav>
{{ end }}

{{define "content"}}
<div class="container-fluid graphs-metrics-container">
    {{ range $metricsContainer := .CurrentGraph.MetricsFromJSONGroupByThree }}
    <div class="row">
        {{ range $metric := $metricsContainer }}
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading" data-id="{{ $metric.ID }}" data-key="{{ $metric.Key }}">{{ $metric.Key }}</div>
                <div class="panel-body">
                    Panel content
                </div>
            </div>
        </div>
        {{ end }}
    </div>
    {{ end }}
</div>

<!-- Add a Chart Modal -->
<div class="modal fade" id="add-chart-modal" tabindex="-1" role="dialog" aria-labelledby="graph-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="watchers-details-label">Add Charts</h4>
            </div>

            <form action="/graphs/{{ $.CurrentGraph.ID }}" method="post">
                <input type="hidden" name="_method" value="put">

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <select class="form-control chart-keys" name="Metrics" multiple size="15">
                            {{ range $metric := .Metrics }}
                                <option data-graph-id="{{ $.CurrentGraph.ID }}" value="{{ $metric.ID }}-{{ $metric.Key }}" data-key="{{ $metric.Key }}">{{ $metric.Key }}</option>
                            {{ end }}
                            </select>
                        </div>

                         <div class="col-md-6" style="padding-left: 0">
                            <div class="add-chart-modal-container"></div>
                         </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function renderChartPreview() {
    var metrics = $('.chart-keys').val();
    var lastMetricIDAndKey = metrics[metrics.length -1].split(/\-(.+)?/);
    var lastMetricID = lastMetricIDAndKey[0];
    var lastMetricKey = lastMetricIDAndKey[1];
    var createdInterval = '15 minute'; // Don't fetch too many things since this is just a preview.

    var modal = $('#add-chart-modal');
    var containerDOM = modal.find('.add-chart-modal-container');


    $.ajax({
        url: "/api/metrics/" + lastMetricID + "?CreatedInterval=" + createdInterval,
        beforeSend: function(xhr) {
            xhr.setRequestHeader("Authorization", "Basic " + window.btoa("{{ $.AccessToken.Token }}:"));
        },
        success: function(result) {
            containerDOM.highcharts({
                chart: {
                    height: ResourcedMaster.highcharts.defaultHeight + 6
                },
                title: {
                    text: lastMetricKey
                },
                series: result
            });
        }
    });
}

function renderChart() {
    $('.graphs-metrics-container .panel-heading').each(function() {
        var metricID = $(this).data('id');
        var metricKey = $(this).data('key');
        var createdInterval = '15 minute';

        var containerDOM = $(this).siblings('.panel-body');

        $.ajax({
            url: "/api/metrics/" + metricID + "?CreatedInterval=" + createdInterval,
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Basic " + window.btoa("{{ $.AccessToken.Token }}:"));
            },
            success: function(result) {
                containerDOM.highcharts({
                    chart: {
                        width: containerDOM.width(),
                        height: ResourcedMaster.highcharts.defaultHeight
                    },
                    title: {
                        text: ''
                    },
                    series: result
                });
            }
        });
    });
}

$(window).resize(function() {
    $('.graphs-metrics-container .panel-body').each(function() {
        $(this).highcharts().setSize(
            $(this).width(), ResourcedMaster.highcharts.defaultHeight, doAnimation = false
        );
    });
});

$(document).ready(function() {
    renderChart();
});

$(document).on('change','.chart-keys', renderChartPreview);

$('.graphs-select').change(function() {
    window.location = '/graphs/' + $(this).val();
});

$('#add-chart-modal').on('shown.bs.modal', function() {
    var modal = $(this);
    var currentMetricKeysDOM = $('.graphs-metrics-container .panel-heading');

    modal.find('.chart-keys option').each(function(index) {
        var chartKeyOption = $(this);

        $('.graphs-metrics-container .panel-heading').each(function(index) {
            if(chartKeyOption.data('key') == $(this).data('key')) {
                chartKeyOption.attr('selected', 'selected');
            }
        });
    });

    renderChartPreview();
});
</script>
{{end}}
